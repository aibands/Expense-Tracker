<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=390, initial-scale=1.0">
    <title>transaction (390px)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@100;200;300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #0b1320;
            --card: #20243d;
            --teal-start: #1f6b74;
            --teal-end: #2d8a9a;
            --history: red;
            --leftbt: #9598A9;
            --plus: #528E2F;
            --editbg: #1B546C;
            --food: #EB84AF;
            --food: #EB84AF;
            --transportation: #C38D5D;
            --entertainment: #C29BEE;
            --rent: #2899F4;
        }

        h1 {
            font-family: 'poppins', sans-serif;
            font-weight: 700;
        }

        .icon {
            overflow: hidden;
            background: white;
            border-radius: 20%;
            margin: 20px 10px;
        }

        .leftbox {
            font-family: 'Urbanist', sans-serif;
        }

        .title {
            font-family: 'Urbanist', sans-serif;
            font-weight: 400;
            line-height: 150%;
            font-size: 14px;
        }

        .rightbox {
            font-family: 'Urbanist', sans-serif;
            font-weight: 300;
            margin-left: auto;
            margin-right: 10px;
            text-align: right;
        }

        .detail {
            font-size: 12px;
            font-weight: 400;

        }

        .editPart {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            position: absolute;
            right: -72px;
            top: 8;
            z-index: 10;

        }

        .shirinkPart.active .editPart {
            opacity: 1;
            pointer-events: auto;


        }




        .shirinkPart {
            width: 100%;
            max-width: 350px;

            border-radius: 10px;
            overflow: visible;
            position: relative;
            transition: transform 0.5s ease, width 0.5s ease;
            cursor: pointer;
            z-index: 100;
        }


        .shirinkPart.active {


            width: calc(100% - 80px);

            z-index: 999;
        }

        @media (max-width: 360px) {
            .shirinkPart.active {
                transform: translateX(-30px);
                width: calc(100% - 30px);
            }
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>

<body>
    <main>
        <section class="container min-h-screen flex flex-col items-center gap-[30px] bg-[var(--bg)] pb-[5.4rem]"
            style=" color:white; padding-top: 3rem; ">

            <!-- Title -->
            <div class="flex flex-row mb-[1.5rem] relative w-[340px]">
                <h1 class="text-[20px] font-bold mx-auto">Transaction</h1>
            </div>

            <!-- Cards -->

            <div id="cards" class=" gap-4">

            </div>


        </section>


        <nav
            class="fixed bottom-0 left-0 w-full bg-[var(--card)] flex justify-around items-center py-3 border-t border-gray-700">
            <button class="flex flex-col items-center" id="home">
                <img src="../assets/logo/default_home.svg" alt="home" class="w-5 h-5">
            </button>
            <button class="flex flex-col items-center" id="receipt">
                <img src="../assets/logo/export_transaction.svg" alt="note" class="w-5 h-5">
            </button>
            <button class="flex flex-col items-center" id="open-form">
                <img src="../assets/logo/default_add.svg" alt="plus" class="w-6 h-6">
            </button>
            <button class="flex flex-col items-center" id="category">
                <img src="../assets/logo/default_categories.svg" alt="grid" class="w-5 h-5">
            </button>
            <button class="flex flex-col items-center" id="openSettings">
                <img src="../assets/logo/default_setting.svg" alt="settings" class="w-5 h-5">
            </button>
        </nav>

    </main>

    <script>
        document.getElementById('open-form').addEventListener('click', () => window.location.href = "./saveTransaction.html");
        document.getElementById('home').addEventListener('click', () => window.location.href = "../index.html");
        document.getElementById('receipt').addEventListener('click', () => window.location.href = "./transaction.html")
        document.getElementById('category').addEventListener('click', () => window.location.href = "./categories.html")
        document.getElementById('openSettings').addEventListener('click', () => window.location.href = "./setting.html")
    </script>


        <!-- Edit Modal -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[9999]">
    <div class="bg-[var(--bg)] text-white p-6 rounded-2xl w-[100%] max-w-[400px] flex flex-col gap-3 shadow-lg">
        <h2 class="text-lg font-semibold mb-2 text-center">Edit Transaction</h2>

        <label class="text-sm">Amount</label>
        <input id="editAmount" type="number"
            class="bg-white p-2 rounded-lg text-sm outline-none border border-gray-600">

        <label class="text-sm">Category</label>
        <input id="editCategory" type="text"
            class="bg-white p-2 rounded-lg text-sm outline-none border border-gray-600">

        <label class="text-sm">Description</label>
        <input id="editDescription" type="text"
            class="bg-white p-2 rounded-lg text-sm outline-none border border-gray-600">

        <div class="flex ml-4 gap-2 mt-4">
            <button id="cancelEdit" class="px-[60px] ml-[-10px] py-2 bg-gray-300 rounded-lg text-lg text-black">Cancel</button>
            <button id="saveEdit" class="px-[60px] py-2 bg-[var(--editbg)] rounded-lg text-lg text-white">Save</button>
        </div>
    </div>
</div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteModal"
            class="fixed ml-[-30px]  inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[9999]">
            <div class="bg-white text-black p-6 rounded-2xl w-[350px] flex flex-col gap-4 shadow-lg relative">
                <!-- Close button -->
                <button id="closeDeleteModal"
                    class="absolute top-3 right-3 text-black text-lg font-bold">&times;</button>
                <h2 class="text-lg font-bold text-center">Delete Transaction</h2>
                <h2 class="text-lg text-center">Are you sure you want to delete this transaction?</h2>

                <div class="flex ml-4 gap-2 mt-4">
                    <button id="cancelDelete" class="px-12 py-2 bg-gray-300 rounded-lg text-lg">No</button>
                    <button id="confirmDelete"
                        class="px-12 py-2 bg-[var(--bg)] rounded-lg text-lg text-white">Yes</button>
                </div>
            </div>
        </div>




        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            $(document).ready(function () {

                const transactions = JSON.parse(localStorage.getItem('transactions')) || [];
                const categories = JSON.parse(localStorage.getItem('categories')) || [];
                let currentEditIndex = null;
                let lastFocusedButton = null;

                // cards
                for (let transaction of transactions) {

                    const categoriaInfo = categories.find(cat => cat.name === transaction.category);
                    if(categoriaInfo.color){
                        categoriaInfo.color = categoriaInfo.color.replace(/\s+/g, '');
                    }
                    
                    $('#cards').append(`
        <div class="shirinkPart bg-gradient-to-br block w-[350px] h-[75px] p-[8px] rounded-lg shadow-lg transform hover:left transition-transform duration-300 mb-[10px] relative">
            <div class="editPart bg-[var(--editbg)] rounded-lg flex flex-row justify-end w-[334px] h-[80px] p-[8px] z-[-1] absolute gap-[5px]">  
                <button class="editBt">
                    <img src="../assets/img/PencilSimple.png" alt="Edit" style="width:30px;height:30px;">
                </button>
                <button class="deleteBt">
                    <img src="../assets/img/Trash.png" alt="Delete" style="width:30px;height:30px;">
                </button>
            </div>  
            <div class="bg-[var(--card)] text-white rounded-lg flex flex-row items-center">
                <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-[${categoriaInfo.color}]">
                    <p class="text-[20px]">${categoriaInfo.emoji}</p>
                </div>
                <div class="leftbox p-4">
                    <p class="title">${transaction.description || transaction.category}</p>
                    <p class="detail text-[var(--leftbt)]">${transaction.category}</p>
                </div>
                <div class="rightbox">
                    <h2 class="text-[${transaction.type === 'income' ? 'var(--plus)' : 'var(--history)'}] text-[14px]">
                        ${transaction.type === 'income' ? '+' : '-'}$${transaction.amount}
                    </h2>
                    <p class="detail text-[var(--leftbt)]">${transaction.date}</p>
                </div>
            </div>
        </div>`);
            }

                // slidebyclick
                $('#cards').on('click', '.shirinkPart', function (e) {
                    const clickedCard = $(this);
                    $('.shirinkPart').not(clickedCard).removeClass('active');
                    clickedCard.toggleClass('active');
                });

                // edit
                $('#cards').on('click', '.editBt', function (e) {
                    e.stopPropagation();
                    const card = $(this).closest('.shirinkPart');
                    currentEditIndex = card.index();
            
                    const t = transactions[currentEditIndex];
                    if(t.id){
                        window.location.href = `./saveTransaction.html?transactionId=${t.id}`
                    }
                });

                // save
                $('#saveEdit').on('click', function () {
                    if (currentEditIndex === null) return;

                    const updated = {
                        ...transactions[currentEditIndex],
                        description: $('#editDescription').val(),
                        category: $('#editCategory').val(),
                        amount: $('#editAmount').val()
                    };

                    transactions[currentEditIndex] = updated;
                    localStorage.setItem('transactions', JSON.stringify(transactions));

                    // update
                    const card = $('#cards .shirinkPart').eq(currentEditIndex);
                    card.find('.title').text(updated.description);
                    card.find('.leftbox .detail').text(updated.category);
                    card.find('.rightbox h2').text((updated.type === 'income' ? '+' : '-') + '$' + updated.amount);

                    $('#editModal').addClass('hidden').removeClass('flex');
                    if (lastFocusedButton) lastFocusedButton.focus();
                });

                // cancel
                $('#cancelEdit').on('click', function () {
                    $('#editModal').addClass('hidden').removeClass('flex');
                    if (lastFocusedButton) lastFocusedButton.focus();
                });

                // Esc close
                $(document).on('keydown', function (e) {
                    if (e.key === "Escape" && !$('#editModal').hasClass('hidden')) {
                        $('#editModal').addClass('hidden').removeClass('flex');
                        if (lastFocusedButton) lastFocusedButton.focus();
                    }
                });

                let deleteIndex = null;

                // Delete button click -> show confirmation modal
                $('#cards').on('click', '.deleteBt', function (e) {
                    e.stopPropagation();
                    deleteIndex = $(this).closest('.shirinkPart').index();
                    $('#deleteModal').removeClass('hidden').addClass('flex');
                });

                // Cancel deletion
                $('#cancelDelete, #closeDeleteModal').on('click', function () {
                    deleteIndex = null;
                    $('#deleteModal').addClass('hidden').removeClass('flex');
                });

                // Confirm deletion
                $('#confirmDelete').on('click', function () {
                    if (deleteIndex === null) return;

                    transactions.splice(deleteIndex, 1);
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    $('#cards .shirinkPart').eq(deleteIndex).remove();

                    deleteIndex = null;
                    $('#deleteModal').addClass('hidden').removeClass('flex');
                });





            });
        </script>


    </main>


</body>

</html>